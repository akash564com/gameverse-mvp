{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">{{ game.name }}</h2>
{% if game.slug == 'tictactoe' %}
  <div class="row">
    <div class="col-md-6">
      <div class="mb-2">
        <label>Room ID</label>
        <input id="room" class="form-control" value="public" />
        <button id="join" class="btn btn-primary mt-2">Join Room</button>
        <button id="reset" class="btn btn-warning mt-2">Reset</button>
      </div>
      <div id="board" class="d-grid" style="grid-template-columns:repeat(3,100px);gap:6px">
        {% for i in range(9) %}
          <button class="btn btn-outline-light" data-idx="{{ i }}" style="height:100px;font-size:2rem"></button>
        {% endfor %}
      </div>
      <div class="mt-3">
        <div>Turn: <span id="turn">-</span></div>
        <div>Winner: <span id="winner">-</span></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io();
    const boardEl = document.getElementById('board');
    const winnerEl = document.getElementById('winner');
    const turnEl = document.getElementById('turn');
    document.getElementById('join').onclick = () => {
      socket.emit('join', {room: document.getElementById('room').value || 'public'});
    };
    document.getElementById('reset').onclick = () => {
      socket.emit('reset', {room: document.getElementById('room').value || 'public'});
    };
    boardEl.addEventListener('click', e => {
      const b = e.target.closest('button[data-idx]');
      if(!b) return;
      socket.emit('move', {room: document.getElementById('room').value || 'public', idx: b.dataset.idx});
    });
    socket.on('state', (s) => {
      [...boardEl.querySelectorAll('button')].forEach((btn,i)=>{ btn.textContent = s.board[i] || ''; });
      turnEl.textContent = s.turn || '-';
      winnerEl.textContent = s.winner || '-';
    });
    // Auto join default room
    socket.emit('join', {room: 'public'});
  </script>
{% else %}
  <div class="ratio ratio-16x9 border rounded bg-black">
    <iframe src="{{ url_for('static', filename='games/' ~ game.slug ~ '/index.html') }}"
        style="width:100%; height:90vh; border:none;"></iframe>
  </div>
{% endif %}
<p class="mt-3">
  <a class="btn btn-outline-light" href="{{ url_for('leaderboard', slug=game.slug) }}">View Leaderboard</a>
</p>
{% endblock %}
